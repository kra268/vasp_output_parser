import os
import pandas as pd
from glob import glob
from utils import get_name

# Function to read energy values from OSZICAR files
def read_energy_values(file_path):
    with open(file_path, "r") as f:
        contents = f.read()
        lines = contents.split("\n")
        energies = []
        for line in lines:
            if line.startswith("  "):
                parts = line.split()
                energies.append(parts[4])
        return energies


# Function to clean energy values
def clean_energy_values(energies):
    return [energy for energy in energies if energy != 'eps']


# Function to extract the number from a file name
def extract_number(file_name):
    try:
        return int(file_name.split("POSCAR")[-1].split("_")[-1])
    except ValueError:
        print('ValueError: Error in the file name')


# Function to sort file names based on the extracted number
def sort_file_names(file_names):
    return sorted(file_names, key=extract_number)


# Function to generate the target value array
def generate_target_value_array(pos_path):
    target_value_array = []
    for di in glob(f'{pos_path}/*'):
        dir_path = di
        poscar_name = os.path.split(dir_path)[-1]
        target_value_array.append(poscar_name)
    return target_value_array


# Function to create the target value dataframe
def create_target_value_dataframe(sorted_filenames, energies):
    #sorted_file_names = sort_file_names(file_names)
    target_value_dataframe = pd.DataFrame(sorted_filenames, columns=None)
    energy = pd.Series(energies)
    target_value_dataframe['energy'] = energy.values
    return target_value_dataframe


# Function to save the dataframe to a CSV file
def save_dataframe_to_csv(dataframe, destination_path, csv_name):
    dataframe.to_csv(
        os.path.join(destination_path, csv_name),
        index=False, mode='a', header=False, sep=','
    )


if __name__ == '__main__':
    pos_path = os.path.join('/'.join(os.getcwd().split('/')), 'POSCAR_files')
    osz_path = os.path.join('/'.join(os.getcwd().split('/')), 'OUTCAR_files')
    destination_path = os.getcwd()
    # Get the list of directories in POSCAR_files
    poscar_list = [p for p in glob(f'{pos_path}/*')]
    # Loop through each directory
    for l in poscar_list:
        filenames = generate_target_value_array(l)
        f_name = l.split('/')[-1]
        f, m, s = f_name.split('_')
        sorted_filenames = sort_file_names(filenames)
        # Loop through each file in OUTCAR_files directory
        for file_path in glob(f'{osz_path}/*'):
            file = file_path.split('/')[-1]
            filename, molecule, site = get_name(file)  # Splitting file name. We need only OSZICAR files
            if filename == 'OSZICAR' and molecule == m and site == s:  # Checking if the file is OSZICAR
                energies = read_energy_values(os.path.join(file_path))
                energies = clean_energy_values(energies)
                csv_name = f'{molecule}_{site}_id_prop.csv'
                target_value_dataframe = create_target_value_dataframe(sorted_filenames, energies)
                save_dataframe_to_csv(target_value_dataframe, destination_path, csv_name)

